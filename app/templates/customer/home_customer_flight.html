{% extends "customer/home_customer.html" %}
{% block title %}Your Flights{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/flight_page_overrides.css') }}">
<style>
  .flight-wrapper {
    border-radius: 8px;
  }
  .section-divider {
    height: 1px;
    background-color: #dee2e6;
    margin: 30px 0;
  }
</style>
{% endblock %}

{% block content %}
{% macro badge(status) -%}
  {% if   status=='on-time'   %}<span class="badge bg-success">On&nbsp;Time</span>
  {% elif status=='delayed'   %}<span class="badge bg-warning text-dark">Delayed</span>
  {% elif status=='cancelled' %}<span class="badge bg-danger">Cancelled</span>
  {% elif status=='completed' %}<span class="badge bg-success">Completed</span>
  {% else                     %}<span class="badge bg-secondary">{{ status }}</span>
  {% endif %}
{%- endmacro %}

<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-xl-9">

      <div class="card flight-wrapper border-0 shadow-sm">
        <div class="card-body">

          <h1 class="mb-4">Your Flights</h1>

          {% if not upcoming_flights and not past_flights %}
            <div class="alert alert-info">
              You haven't booked any flights yet.
              <a href="{{ url_for('mainCust.home_cust_search') }}">Search for flights</a> to get started.
            </div>

          {% else %}
            <!-- Upcoming Flights Section -->
            <h2 class="h4 mb-3">Upcoming Flights</h2>
            {% if not upcoming_flights %}
              <div class="alert alert-info mb-4">You don't have any upcoming flights.</div>
            {% else %}
              <div class="table-responsive mb-5">
                <table class="table table-striped table-hover align-middle">
                  <thead class="table-dark">
                    <tr>
                      <th>Airline</th><th>Flight&nbsp;#</th><th>From</th><th>To</th>
                      <th>Departure</th><th>Arrival</th><th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for f in upcoming_flights %}
                      <tr>
                        <td>{{ f.Airline_name }}</td>
                        <td>{{ f.flight_no }}</td>
                        <td>{{ f.departure_airport }} ({{ f.departure_city }})</td>
                        <td>{{ f.arrival_airport }} ({{ f.arrival_city }})</td>
                        <td class="text-nowrap">{{ f.departure_date_and_time }}</td>
                        <td class="text-nowrap">{{ f.arrival_date_and_time }}</td>
                        <td>{{ badge(f.status) }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}
            
            <div class="section-divider"></div>
            
            <!-- Past Flights Section -->
            <h2 class="h4 mb-3">Past Flights</h2>
            {% if not past_flights %}
              <div class="alert alert-info">You don't have any past flights.</div>
            {% else %}
              <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                  <thead class="table-secondary">
                    <tr>
                      <th>Airline</th><th>Flight&nbsp;#</th><th>From</th><th>To</th>
                      <th>Departure</th><th>Arrival</th><th>Status</th>
                      
                      <!-- Check if any completed flights exist in a way that works with Jinja2 -->
                      {% set has_completed = false %}
                      {% for flight in past_flights %}
                        {% if flight.status == 'completed' %}
                          {% set has_completed = true %}
                        {% endif %}
                      {% endfor %}
                      
                      {% if has_completed %}
                        <th>Actions</th>
                      {% endif %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for f in past_flights %}
                      <tr>
                        <td>{{ f.Airline_name }}</td>
                        <td>{{ f.flight_no }}</td>
                        <td>{{ f.departure_airport }} ({{ f.departure_city }})</td>
                        <td>{{ f.arrival_airport }} ({{ f.arrival_city }})</td>
                        <td class="text-nowrap">{{ f.departure_date_and_time }}</td>
                        <td class="text-nowrap">{{ f.arrival_date_and_time }}</td>
                        <td>{{ badge(f.status) }}</td>
                        
                        {% if f.status == 'completed' %}
                          <td>
                            <a href="{{ url_for('mainCust.home_cust_rate') }}"
                               class="btn btn-sm btn-primary">
                              Rate
                            </a>
                          </td>
                        {% elif has_completed %}
                          <td></td>
                        {% endif %}
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}
          {% endif %}
        </div><!-- /.card-body -->
      </div><!-- /.card -->
    </div><!-- /.col -->
  </div><!-- /.row -->
</div><!-- /.container-fluid -->
{% endblock %}